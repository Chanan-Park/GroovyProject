<?xml version="1.0" encoding="UTF-8"?>
<!-- mapper 기본설정 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체 내에서 유일해야 함, 주로 파일명) -->

<mapper namespace="jinseok">
	<!-- #### 중요 #### 	
		 HashMap 타입으로 매개변수를 받아온 것을 꺼내서 사용할때 
		 1. 데이터로 사용할때는 #{key명} 이고,
		 2. 식별자(테이블명, 컬럼명)로 사용할때는 ${key명} 이고,
		 3. myBatis 에서 제공하는 if 엘리먼트나 choose 엘리먼트 안에서 사용할때는 
		       그냥 <if test="key명"> <when test="key명"> 으로 사용한다. 
	-->

	<select id="getTotalCount" parameterType="HashMap" resultType="int">
	    select count(*)
	    from tbl_mail M  right JOIN TBL_MAIL_Recipient R  
   		ON R.fk_mail_no = M.mail_no
	    <![CDATA[where SEND_TIME <= sysdate]]>	    
		
       	<if test='listType == "FK_Sender_address"'>
       		and  ${listType} = #{mail_address}
       	</if>
       	<if test='listType == "FK_Recipient_address"'>    	
    		and  (FK_Recipient_address_individual = #{mail_address})
    			  or (FK_REFERENCED_ADDRESS_individual = #{mail_address})
    	</if>
    	<if test='listType == "important"'>    	
    		and ((FK_Recipient_address_individual = #{mail_address} and Recipient_IMPORTANT = 1)
    			  or (FK_Sender_address = #{mail_address} and SENDER_IMPORTANT = 1))
    	</if>
			 
	</select>
		
		<!-- 페이징한 메일 정보만 가져오기-->
	<select id="mailListSearchWithPaging" parameterType="HashMap" resultType="com.spring.groovy.mail.model.MailVO"> 
	    select *
		from 
		(
		    select rownum AS rno, V.*
		    from 
		    (
		        select M.MAIL_NO,M.FK_SENDER_ADDRESS,M.FK_RECIPIENT_ADDRESS
		        ,M.SUBJECT,M.contents,M.send_Time,M.SENDER_DELETE,M.SENDER_IMPORTANT
		        ,M.FILENAME, M.ORGFILENAME, M.FILESIZE,M.MAIL_PWD
		        <if test='listType == "FK_Recipient_address"'>   
		        	,R.FK_RECIPIENT_ADDRESS_individual,R.FK_REFERENCED_ADDRESS_individual,R.READ_CHECK,R.RECIPIENT_DELETE,R.RECIPIENT_IMPORTANT
				</if>
			
			   from tbl_mail M  
			   <if test='listType == "FK_Recipient_address"'>
				   right JOIN TBL_MAIL_Recipient R  
				   ON R.fk_mail_no = M.mail_no
			   </if>
		        <!-- <![CDATA[]]> 파싱하지 않고 문자 그대로 들어감 -->
		        <![CDATA[where SEND_TIME <= sysdate]]>
		        <if test='listType != ""'>		
		        	<if test='listType == "FK_Sender_address"'>
		        		and  ${listType} = #{mail_address}
		        	</if>
		        	<if test='listType == "FK_Recipient_address"'>    	
			    		and  (FK_Recipient_address_individual = #{mail_address})
			    			  or (FK_REFERENCED_ADDRESS_individual = #{mail_address})
			    	</if>
			    	<if test='listType == "important"'>    	
			    		and ((FK_Recipient_address_individual = #{mail_address} and Recipient_IMPORTANT = 1)
			    			  or (FK_Sender_address = #{mail_address} and SENDER_IMPORTANT = 1))
			    	</if>
			    </if>
		        
			    <if test='searchType != "" and searchWord != "" '>
			    	
			    	and lower(${searchType}) like '%'||lower(#{searchWord})||'%'
			    </if>

		        order by SEND_TIME desc
		    ) V
		) T 
		where rno between #{startRno} and #{endRno} 
	</select>
	
	<!-- 태그 리스트 가져오기 -->
	<select id="getTagList" parameterType="String" resultType="com.spring.groovy.mail.model.TagVO"> 
		select * 
		from tbl_tag
		where FK_mail_address = #{mail_address}
		order by fk_MAIL_NO asc, tag_color asc
	</select>
	
	<!-- 태그 리스트 가져오기 (사이드바 전용)-->
	<select id="getTagListSide" parameterType="String" resultType="com.spring.groovy.mail.model.TagVO"> 
		select distinct FK_MAIL_ADDRESS,TAG_COLOR,TAG_NAME
		from tbl_tag
		where FK_mail_address = #{mail_address}
		order by tag_color asc
	</select>
	
	<!-- 태그 리스트 가져오기 -->
	<select id="getTagListByMailNo" parameterType="HashMap" resultType="com.spring.groovy.mail.model.TagVO"> 
		select * 
		from tbl_tag
		where FK_mail_address = #{FK_MAIL_ADDRESS}
		<if test="mailNo != null">
			and fk_MAIL_NO = #{mailNo}
		</if>
	</select>
	
	
	<!-- 메일 채번하기 -->
	<select id="getSeqMailNo" resultType="int">
		select seq_mail_no.nextval
		from dual
	</select>
	<!-- 메일 추가하기 -->
	<insert id="addMail" parameterType="HashMap">
		insert into tbl_mail(MAIL_NO, FK_Sender_address,FK_Recipient_address,SUBJECT, CONTENTS,
							SEND_TIME,mail_pwd,orgFilename,fileName,fileSize)
					values(#{mail_no}, #{FK_Sender_address} ,#{FK_Recipient_address},#{subject},#{contents},
		
		<choose>
	    	<when test="send_time == ''">
	    	    sysdate,
	    	</when>
	    	<otherwise>
	    	    to_date(#{send_time},'mm/dd/yyyy hh24:mi:ss'),
	    	</otherwise>
	    </choose>
	    
	    <choose>
	    	<when test="mail_pwd == ''">
	    	    null,
	    	</when>
	    	<otherwise>
	    	    to_date(#{send_time},'mm/dd/yyyy hh24:mi:ss'),
	    	</otherwise>
	    </choose>
	    
	    <choose>
	    	<when test="originalFilename == ''">
	    	    null,
	    	</when>
	    	<otherwise>
	    	    #{originalFilename},
	    	</otherwise>
	    </choose>
	    
	    <choose>
	    	<when test="newFileName == ''">
	    	    null,
	    	</when>
	    	<otherwise>
	    	    #{newFileName},
	    	</otherwise>
	    </choose>
	    <choose>
	    	<when test="fileSize == ''">
	    	    null
	    	</when>
	    	<otherwise>
	    	    #{fileSize}
	    	</otherwise>
	    </choose>
		
		

		
		)
		
	</insert>
	
	<!-- 하위 메일 추가하기 -->
	<insert id="addMailRecipient" parameterType="HashMap">
		insert into TBL_MAIL_Recipient(MAIL_Recipient_NO,FK_MAIL_NO, ${addressType})
		values(seq_mail_recipient_no.nextval,#{mail_no},#{address})
	</insert>
	
	
	<!-- 메일 하나 가져오기 -->
	<select id="getOneMail" parameterType="String" resultType="com.spring.groovy.mail.model.MailVO"> 
		select * 
		from tbl_mail
		where mail_no = #{mailNo}
	</select>
	
	<!--  메일리스트 가져오기 (자동완성용) -->
	<select id="getMailList" resultType="String"> 
		select '"'||department||' '||position||' '||name||'<![CDATA[<]]>'||cpemail||'<![CDATA[>]]>'||'"' as cpemail
		from tbl_employee
	</select>
		
	<!--  메일 읽음 처리하기 -->
	<update id="readMail" parameterType = "HashMap" >
		update TBL_MAIL_Recipient set read_check =  1
   		where fk_MAIL_NO = ${mailNo}
   		and FK_RECIPIENT_ADDRESS_INDIVIDUAL = #{FK_MAIL_ADDRESS}
	</update>	
	
	<!-- 중요체크 되있는지 확인 -->
	<select id="importantCheck" parameterType="String" resultType="int"> 
		select RECIPIENT_IMPORTANT
		from TBL_MAIL_Recipient
		where MAIL_RECIPIENT_NO=#{mail_recipient_no}
	</select>
	
	<!-- 중요체크 추가 or 해제 -->
	<update id="importantUpdate" parameterType = "HashMap" >
	
		update TBL_MAIL_Recipient 
		<if test="readcheck == 0">
		set read_check =  1
		</if>
		<if test="readcheck == 1">
		set read_check =  0
		</if>
   		where mail_recipient_no = ${mail_recipient_no}
	</update>
		
</mapper>