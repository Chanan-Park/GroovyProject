<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chanan">
	
	<!-- 팀 문서함 게시글 수 조회 -->
	<select id="getTeamDraftCnt" resultType="int" parameterType="HashMap" >
		SELECT COUNT(*) FROM VIEW_TEAM_DRAFT
		WHERE DRAFT_DEPARTMENT = #{department}
		<if test='searchType != "" and searchWord != "" '>
		AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		</if>
	</select>
	
	<!-- 팀 문서함 목록 조회 -->
	<select id="getTeamDraftList" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="HashMap" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT *
		            FROM
		            VIEW_TEAM_DRAFT
		            <if test='searchType != "" and searchWord != "" '>
		            WHERE LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		            </if>
					ORDER BY ${sortType} ${sortOrder}
		            )A )
		WHERE RNO BETWEEN #{startRno} AND #{endRno}
		AND DRAFT_DEPARTMENT = #{department}
	</select>
		
	<!-- 개인 문서함-상신함 게시글 수 조회 -->
	<select id="getSentDraftCnt" resultType="int" parameterType="HashMap" >
		SELECT COUNT(*) FROM VIEW_DRAFT_SENT
		WHERE FK_DRAFT_EMPNO = #{empno}
		<if test='searchType != "" and searchWord != "" '>
		AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		</if>
		
	</select>
	
	<!-- 개인문서함-상신함 목록 조회 -->
	<select id="getSentDraftList" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="HashMap" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT *
		            FROM
		            VIEW_DRAFT_SENT
		            <if test='searchType != "" and searchWord != "" '>
		            WHERE LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		            </if>
		            ORDER BY ${sortType} ${sortOrder}
		            )A )
		WHERE RNO BETWEEN #{startRno} AND #{endRno}
		AND FK_DRAFT_EMPNO = #{empno}
	</select>
		
	<!-- 개인 문서함-결재함 게시글 수 조회 -->
	<select id="getProcessedDraftCnt" resultType="int" parameterType="HashMap" >
		SELECT COUNT(*) FROM VIEW_DRAFT_PROCESSED
		WHERE FK_APPROVAL_EMPNO = #{empno}
		<if test='searchType != "" and searchWord != "" '>
		AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		</if>
	</select>
	
	<!-- 개인문서함-결재함 목록 조회 -->
	<select id="getProcessedDraftList" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="HashMap" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT *
		            FROM
		            VIEW_DRAFT_PROCESSED
		            <if test='searchType != "" and searchWord != "" '>
		            WHERE LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		            </if>
		            ORDER BY ${sortType} ${sortOrder}
		            )A )
		WHERE RNO BETWEEN #{startRno} AND #{endRno}
		AND FK_APPROVAL_EMPNO = #{empno}
	</select>
		
	<!-- 개인 문서함-임시저장함 게시글 수 조회 -->
	<select id="getSavedDraftCnt" resultType="int" parameterType="HashMap" >
		SELECT COUNT(*) FROM TBL_DRAFT
		WHERE TEMP = 1
		AND FK_DRAFT_EMPNO = #{empno}
		<if test='searchType != "" and searchWord != "" '>
		AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		</if>
	</select>
	
	<!-- 개인문서함-임시저장함 목록 조회 -->
	<select id="getSavedDraftList" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="HashMap" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT DRAFT_TYPE, DRAFT_SEQ, FK_DRAFT_EMPNO, DRAFT_DATE,
					DRAFT_SUBJECT, NAME AS DRAFT_EMP_NAME
					FROM TBL_DRAFT JOIN
					TBL_EMPLOYEE
					ON EMPNO = FK_DRAFT_EMPNO
					WHERE TEMP = 1
					AND FK_DRAFT_EMPNO = #{empno}
					<if test='searchType != "" and searchWord != "" '>
					AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
					</if>
					ORDER BY ${sortType} ${sortOrder}
					)A )
		WHERE RNO BETWEEN #{startRno} AND #{endRno}
	</select>
	
	<!-- 개인문서함-임시저장함 글 삭제 -->
	<delete id="deleteDraftList" parameterType="map">
		DELETE FROM TBL_DRAFT
		WHERE DRAFT_SEQ IN
		<foreach collection="array" item="seq" open="(" close=")" separator=",">
				#{seq}
		</foreach>
	</delete>
	
	<!-- 홈 - 결재완료 문서 5개 조회 -->
	<select id="getMyDraftProcessed" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="String" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT *
		            FROM
		            VIEW_DRAFT_SENT
		            WHERE DRAFT_STATUS != 0
		            ORDER BY APPROVAL_DATE DESC
		            )A )
		WHERE RNO BETWEEN 1 AND 5
		AND FK_DRAFT_EMPNO = #{empno}
	</select>
	
	<!-- 내가 결재해야 할 문서의 문서번호-->
	<select id="getRequestedDraftNo" resultType="int" parameterType="HashMap" >
	SELECT FK_DRAFT_NO
	FROM TBL_APPROVAL A
	WHERE FK_APPROVAL_EMPNO = #{empno} AND APPROVAL_STATUS = 0
	AND FK_DRAFT_NO IN (SELECT FK_DRAFT_NO
	                    FROM TBL_APPROVAL
	                    WHERE LEVELNO = (A.LEVELNO - 1) AND APPROVAL_STATUS = 1)
	</select>
			
	<!-- 결재대기문서 게시글 수 조회 -->
	<select id="getRequestedDraftCnt" resultType="int" parameterType="HashMap" >
		SELECT COUNT(*)
		FROM VIEW_DRAFT_APPROVAL
		WHERE DRAFT_NO IN
		<foreach collection="draftNoList" item="list" open="(" close=")" separator=",">
			#{list}
		</foreach>
		AND FK_APPROVAL_EMPNO = #{empno}
		<if test='searchType != "" and searchWord != "" '>
		AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		</if>
	</select>
		
	<!-- 결재대기문서 목록 조회 -->
	<select id="getRequestedDraftList" resultType="com.spring.groovy.approval.model.DraftVO" parameterType="HashMap" >
		SELECT * 
		FROM ( SELECT A.*, ROWNUM AS RNO
		    FROM ( SELECT *
		            FROM VIEW_DRAFT_APPROVAL
					WHERE DRAFT_NO IN
					<foreach collection="draftNoList" item="list" open="(" close=")" separator=",">
						#{list}
					</foreach>
					AND FK_APPROVAL_EMPNO = #{empno}
		            <if test='searchType != "" and searchWord != "" '>
		            AND LOWER(${searchType}) LIKE '%'||LOWER(#{searchWord})||'%'
		            </if>
		            ORDER BY URGENT_STATUS DESC, ${sortType} ${sortOrder}
		            )A )
		WHERE RNO BETWEEN #{startRno} AND #{endRno}
	</select>
</mapper>